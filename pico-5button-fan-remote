blueprint:
  name: Pico Fan Control - 5 Button with Hold Actions
  description: "Control ceiling fans with a Lutron Pico 5-button remote. Single press for basic control, hold up/down for continuous speed adjustment."
  domain: automation
  author: modified_from_billchurch
  input:
    pico_remote:
      name: Lutron Pico
      selector:
        device:
          model: PJ2-3BRL-GXX-F01 (Pico3ButtonRaiseLower)
          multiple: false
    fan_entity:
      name: Fan
      selector:
        entity:
          domain:
          - fan
          multiple: false
    speed_change_rate:
      name: Speed Change Rate (ms)
      description: How fast to change speed during long press
      default: 500
      selector:
        number:
          min: 200.0
          max: 1000.0
          unit_of_measurement: ms
          step: 50.0
          mode: slider

trigger:
- platform: device
  device_id: !input pico_remote
  domain: lutron_caseta
  type: press
  subtype: 'on'
  id: 'on'
- platform: device
  device_id: !input pico_remote
  domain: lutron_caseta
  type: press
  subtype: raise
  id: up
- platform: device
  device_id: !input pico_remote
  domain: lutron_caseta
  type: press
  subtype: stop
  id: middle
- platform: device
  device_id: !input pico_remote
  domain: lutron_caseta
  type: press
  subtype: lower
  id: down
- platform: device
  device_id: !input pico_remote
  domain: lutron_caseta
  type: press
  subtype: 'off'
  id: 'off'

variables:
  fan: !input fan_entity
  rate_ms: !input speed_change_rate

action:
- choose:
  - conditions:
    - condition: trigger
      id: 'on'
    sequence:
    - service: fan.turn_on
      target:
        entity_id: !input fan_entity

  - conditions:
    - condition: trigger
      id: up
    sequence:
    - wait_for_trigger:
      - platform: device
        device_id: !input pico_remote
        domain: lutron_caseta
        type: release
        subtype: raise
      timeout: '00:00:00.3'
      continue_on_timeout: true
    - if: '{{ wait.trigger is not none }}'
      then:
      # Short press - single speed increase
      - service: fan.increase_speed
        target:
          entity_id: '{{ fan }}'
      else:
      # Long press - continuous speed increase
      - repeat:
          sequence:
          - service: fan.increase_speed
            target:
              entity_id: '{{ fan }}'
          - delay:
              milliseconds: '{{ rate_ms | int }}'
          until:
          - condition: template
            value_template: '{{ state_attr(fan, "percentage") | int >= 100 }}'

  - conditions:
    - condition: trigger
      id: middle
    sequence:
    - service: fan.toggle
      target:
        entity_id: !input fan_entity

  - conditions:
    - condition: trigger
      id: down
    sequence:
    - wait_for_trigger:
      - platform: device
        device_id: !input pico_remote
        domain: lutron_caseta
        type: release
        subtype: lower
      timeout: '00:00:00.3'
      continue_on_timeout: true
    - if: '{{ wait.trigger is not none }}'
      then:
      # Short press - single speed decrease
      - service: fan.decrease_speed
        target:
          entity_id: '{{ fan }}'
      else:
      # Long press - continuous speed decrease
      - repeat:
          sequence:
          - service: fan.decrease_speed
            target:
              entity_id: '{{ fan }}'
          - delay:
              milliseconds: '{{ rate_ms | int }}'
          until:
          - condition: template
            value_template: '{{ state_attr(fan, "percentage") | int <= 0 }}'

  - conditions:
    - condition: trigger
      id: 'off'
    sequence:
    - service: fan.turn_off
      target:
        entity_id: !input fan_entity

mode: restart